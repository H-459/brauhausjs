/*
@preserve
Brauhaus.js Beer Calculator
Copyright 2013 Daniel G. Taylor <danielgtaylor@gmail.com>
https://github.com/danielgtaylor/brauhausjs
*/
(function(){var Brauhaus,tanh,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child};tanh=function(number){return(Math.exp(number)-Math.exp(-number))/(Math.exp(number)+Math.exp(-number))};Brauhaus=typeof exports!=="undefined"&&exports!==null&&exports||(this.Brauhaus={});Brauhaus.COLOR_NAMES=[[2,"pale straw"],[3,"straw"],[4,"pale gold"],[6,"deep gold"],[9,"pale amber"],[12,"medium amber"],[15,"deep amber"],[18,"amber brown"],[20,"brown"],[24,"ruby brown"],[30,"deep brown"],[40,"black"]];Brauhaus.srmToRgb=function(srm){var b,g,r;r=Math.round(Math.min(255,Math.max(0,255*Math.pow(.975,srm))));g=Math.round(Math.min(255,Math.max(0,245*Math.pow(.88,srm))));b=Math.round(Math.min(255,Math.max(0,220*Math.pow(.7,srm))));return[r,g,b]};Brauhaus.srmToCss=function(srm){var b,g,r,_ref;_ref=Brauhaus.srmToRgb(srm),r=_ref[0],g=_ref[1],b=_ref[2];return"rgb("+r+", "+g+", "+b+")"};Brauhaus.srmToName=function(srm){var color,item,_i,_len,_ref;color=Brauhaus.COLOR_NAMES[0][1];_ref=Brauhaus.COLOR_NAMES;for(_i=0,_len=_ref.length;_i<_len;_i++){item=_ref[_i];if(item[0]<=srm){color=item[1]}}return color};Brauhaus.OptionConstructor=function(){function OptionConstructor(options){var property;for(property in options){if(!__hasProp.call(options,property))continue;this[property]=options[property]}}return OptionConstructor}();Brauhaus.Ingredient=function(_super){__extends(Ingredient,_super);function Ingredient(options){this.name="New "+this.constructor.name;Ingredient.__super__.constructor.call(this,options)}Ingredient.prototype.nameRegex=function(regex){var item,result,_i,_len;result=false;if(typeof regex==="string"){result=regex.exec(this.name)}else{for(_i=0,_len=regex.length;_i<_len;_i++){item=regex[_i];if(Array.isArray(item)&&item.length===2){if(item[0].exec(this.name)){result=item[1];break}}else if(typeof item==="string"){result=item.exec(this.name)}else{throw"Invalid regex input!"}}}return result};return Ingredient}(Brauhaus.OptionConstructor);Brauhaus.Fermentable=function(_super){__extends(Fermentable,_super);function Fermentable(){return Fermentable.__super__.constructor.apply(this,arguments)}Fermentable.STEEP=/biscuit|black|cara|chocolate|crystal|munich|roast|special ?b|toast|victory|vienna/i;Fermentable.BOIL=/candi|candy|dme|dry|extract|honey|lme|liquid|sugar|syrup|turbinado/i;Fermentable.PRICES=[[/dry|dme/i,8.8],[/liquid|lme/i,6.6],[/.*/i,4.4]];Fermentable.prototype.weight=1;Fermentable.prototype["yield"]=75;Fermentable.prototype.color=2;Fermentable.prototype.late=false;Fermentable.prototype.type=function(){return this.nameRegex([[Brauhaus.Fermentable.BOIL,"extract"],[/.*/,"grain"]])};Fermentable.prototype.addition=function(){return this.nameRegex([[/mash/i,"mash"],[/steep/i,"steep"],[/boil/i,"boil"],[Brauhaus.Fermentable.BOIL,"boil"],[Brauhaus.Fermentable.STEEP,"steep"],[/.*/,"mash"]])};Fermentable.prototype.gu=function(gallons){if(gallons==null){gallons=1}return this["yield"]*.46214*this.weight*2.20462/gallons};Fermentable.prototype.colorRgb=function(){return Brauhaus.srmToRgb(this.color)};Fermentable.prototype.colorCss=function(){return Brauhaus.srmToCss(this.color)};Fermentable.prototype.colorName=function(){return Brauhaus.srmToName(this.color)};return Fermentable}(Brauhaus.Ingredient);Brauhaus.Spice=function(_super){__extends(Spice,_super);function Spice(){return Spice.__super__.constructor.apply(this,arguments)}Spice.prototype.weight=.025;Spice.prototype.aa=0;Spice.prototype.use="boil";Spice.prototype.time=60;Spice.prototype.form="pellet";return Spice}(Brauhaus.Ingredient);Brauhaus.Yeast=function(_super){__extends(Yeast,_super);function Yeast(){return Yeast.__super__.constructor.apply(this,arguments)}Yeast.prototype.type="ale";Yeast.prototype.form="liquid";Yeast.prototype.attenuation=75;return Yeast}(Brauhaus.Ingredient);Brauhaus.Recipe=function(_super){__extends(Recipe,_super);Recipe.prototype.name="New Recipe";Recipe.prototype.description="Recipe description";Recipe.prototype.author="Anonymous Brewer";Recipe.prototype.boilSize=10;Recipe.prototype.batchSize=20;Recipe.prototype.servingSize=.355;Recipe.prototype.steepEfficiency=.5;Recipe.prototype.mashEfficiency=.75;Recipe.prototype.ibuMethod="tinseth";Recipe.prototype.fermentables=null;Recipe.prototype.spices=null;Recipe.prototype.yeast=null;Recipe.prototype.og=0;Recipe.prototype.fg=0;Recipe.prototype.color=0;Recipe.prototype.ibu=0;Recipe.prototype.abv=0;Recipe.prototype.ogPlato=0;Recipe.prototype.fgPlato=0;Recipe.prototype.abw=0;Recipe.prototype.realExtract=0;Recipe.prototype.calories=0;function Recipe(options){this.fermentables=[];this.spices=[];this.yeast=[];Recipe.__super__.constructor.call(this,options)}Recipe.prototype.add=function(type,values){if(type==="fermentable"){return this.fermentables.push(new Brauhaus.Fermentable(values))}else if(type==="spice"){return this.spices.push(new Brauhaus.Spice(values))}};Recipe.prototype.calculate=function(){var addition,adjustment,attenuation,bitterness,earlyOg,efficiency,fermentable,gravity,mcu,spice,utilization,utilizationFactor,yeast,_i,_j,_k,_len,_len1,_len2,_ref,_ref1,_ref2,_results;this.og=1;this.fg=0;this.ibu=0;earlyOg=1;mcu=0;attenuation=0;_ref=this.fermentables;for(_i=0,_len=_ref.length;_i<_len;_i++){fermentable=_ref[_i];efficiency=1;addition=fermentable.addition();if(addition==="steep"){efficiency=this.steepEfficiency}else if(addition==="mash"){efficiency=this.mashEfficiency}mcu+=fermentable.color*fermentable.weight/this.batchSize*8.34539;gravity=fermentable.gu(this.batchSize*264.172)*efficiency;this.og+=gravity;if(!fermentable.late){earlyOg+=gravity}}this.color=1.4922*Math.pow(mcu,.6859);_ref1=this.yeast;for(_j=0,_len1=_ref1.length;_j<_len1;_j++){yeast=_ref1[_j];if(yeast.attenuation>attenuation){attenuation=yeast.attenuation}}if(attenuation===0){attenuation=75}this.fg=this.og-(this.og-1)*attenuation/100;this.abv=1.05*(this.og-this.fg)/this.fg/.79*100;this.ogPlato=-463.37+668.72*this.og-205.35*this.og*this.og;this.fgPlato=-463.37+668.72*this.fg-205.35*this.fg*this.fg;this.realExtract=.1808*this.ogPlato+.8192*this.fgPlato;this.abw=.79*this.abv/this.fg;this.calories=Math.max(0,(6.9*this.abw+4*(this.realExtract-.1))*this.fg*this.servingSize*10);_ref2=this.spices;_results=[];for(_k=0,_len2=_ref2.length;_k<_len2;_k++){spice=_ref2[_k];bitterness=0;if(spice.aa&&spice.use==="boil"){utilizationFactor=1;if(spice.form==="pellet"){utilizationFactor=1.15}if(this.ibuMethod==="tinseth"){bitterness=1.65*Math.pow(125e-6,earlyOg-1)*((1-Math.pow(Math.E,-.04*spice.time))/4.15)*(spice.aa/100*spice.weight*1e6/this.batchSize)*utilizationFactor;_results.push(this.ibu+=bitterness)}else if(this.ibuMethod==="rager"){utilization=18.11+13.86*tanh((spice.time-31.32)/18.27);adjustment=Math.max(0,(earlyOg-1.05)/.2);bitterness=spice.weight*100*utilization*utilizationFactor*spice.aa/(this.batchSize*(1+adjustment));_results.push(this.ibu+=bitterness)}else{_results.push(void 0)}}else{throw"Unknown IBU method '"+this.ibuMethod+"'!"}}return _results};Recipe.prototype.toXml=function(){var fermentable,xml,_i,_len,_ref;xml='<?xml version="1.0" encoding="utf-8"?><recipes><recipe>';xml+="<fermentables><version>1</version>";_ref=this.fermentables;for(_i=0,_len=_ref.length;_i<_len;_i++){fermentable=_ref[_i];xml+="<name>"+fermentable.name+"</name>";xml+="<type>"+fermentable.type()+"</name>";xml+="<weight>"+fermentable.weight.toFixed(1)+"</weight>";xml+="<yield>"+fermentable["yield"].toFixed(1)+"</yield>";xml+="<color>"+fermentable.color.toFixed(1)+"</color>"}xml+="</fermentables>";return xml+="</recipe></recipes>"};return Recipe}(Brauhaus.OptionConstructor)}).call(this);